<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="team.oha.laboa.dao.AgendaSummaryDao">
    <sql id="tableName">agenda_summary</sql>
    <insert id="save" parameterType="team.oha.laboa.model.AgendaSummaryDo" useGeneratedKeys="true" keyProperty="summaryId">
        INSERT INTO  <include refid="tableName"/>
        (item_id, summarizer_id, status)
        VALUE (#{itemId},#{summarizerId}, #{status})
    </insert>

    <update id="update" parameterType="team.oha.laboa.model.AgendaSummaryDo">
        UPDATE <include refid="tableName"/>
        <set>
            <if test="content != null">content=#{content},</if>
            <if test="summaryTime != null">summary_time=#{summaryTime},</if>
            <if test="status != null">status=#{status},</if>
        </set>
        WHERE summary_id = #{summaryId} and summarizer_id = #{summarizerId}
    </update>

    <select id="listToDo" parameterType="team.oha.laboa.query.agenda.AgendaToDoQuery" resultType="team.oha.laboa.dto.AgendaSummaryDto">
        SELECT
        agenda.title as title,
        agenda_item.summary_time as date,
        agenda_item.summary_time as summary_time
        FROM <include refid="tableName"/>
        JOIN agenda_item ON agenda_item.item_id = <include refid="tableName"/>.item_id
        JOIN agenda ON agenda.agenda_id = agenda_item.agenda_id
        JOIN user ON user.user_id = <include refid="tableName"/>.summarizer_id
        WHERE user.username = #{username} AND agenda.open = 1 AND <include refid="tableName"/>.status = 'todo'
        AND date_format(agenda_item.summary_time,'%Y-%m')=date_format(#{targetDate},'%Y-%m')
        ORDER BY agenda_item.summary_time asc
    </select>

    <insert id="saveByParticipantId" parameterType="java.lang.Integer">
        INSERT INTO  <include refid="tableName"/>
        (item_id, summarizer_id, status)
        SELECT agenda_item.item_id, cooperation_member.user_id, 'todo'
        FROM
        agenda_item ON agenda_item.item_id = <include refid="tableName"/>.item_id
        JOIN agenda ON agenda.agenda_id = agenda_item.agenda_id AND agenda.next_time = agenda_item.summary_time
        JOIN cooperation_agenda ON cooperation_agenda.agenda_id = agenda.agenda_id
        JOIN cooperation_agenda_participant ON cooperation_agenda_participant.cooperation_agenda_id = cooperation_agenda.cooperation_agenda_id
        AND cooperation_agenda_participant.participant_id = #{participantId}
        JOIN cooperation_member ON cooperation_member.member_id = cooperation_agenda_participant.member_id
    </insert>

    <delete id="deleteByParticipantId" parameterType="java.lang.Integer">
        DELETE <include refid="tableName"/>
        FROM  <include refid="tableName"/>
        JOIN agenda_item ON agenda_item.item_id = <include refid="tableName"/>.item_id
        JOIN agenda ON agenda.agenda_id = agenda_item.agenda_id AND agenda.next_time = agenda_item.summary_time
        JOIN cooperation_agenda ON cooperation_agenda.agenda_id = agenda.agenda_id
        JOIN cooperation_agenda_participant ON cooperation_agenda_participant.cooperation_agenda_id = cooperation_agenda.cooperation_agenda_id
        AND cooperation_agenda_participant.participant_id = #{participantId}
        JOIN cooperation_member ON cooperation_member.member_id = cooperation_agenda_participant.member_id
        WHERE <include refid="tableName"/>.status = 'todo' AND agenda_summary.user_id = cooperation_member.user_id
    </delete>
</mapper>